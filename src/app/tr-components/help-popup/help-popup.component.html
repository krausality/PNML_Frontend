<div fxLayout="row" fxLayoutAlign="space-between center" class="header-area">
    <h1 mat-dialog-title class="help-title">
        Help: {{ TabState[uiService.tab] }}
    </h1>

    <button mat-dialog-close mat-icon-button class="close-button">
        <mat-icon>close</mat-icon>
    </button>
</div>

<div mat-dialog-content>
    <!-- Infotext for Build Mode ****************************************** -->
    <ng-container *ngIf="uiService.tab === TabState.Build">
        <h2>Overview</h2>
        <p>In Build mode you can:</p>
        <ul>
            <li>Build a new petri net from scratch.</li>
            <li>Modify an existing petri net.</li>
            <li>
                Load a petri net from file with drag and drop into the canvas
                area (supported file formats: pnml, json).
            </li>
        </ul>
        <p>
            For most actions, you activate the appropriate action mode by
            selecting the corresponding button. While the mode is activated
            (button is highlighted in red) you can perform the actions belonging
            to this mode. A few buttons will directly perform the action
            ('Delete all' and layout buttons) or open a popup window ('Edit
            actions').
        </p>

        <div class="grid">
            <h2 class="grid-span-2">Blitz tool</h2>
            <mat-icon class="help-icon">bolt</mat-icon>
            <div>
                <p>
                    If a place or transition is selected, an arc from the
                    selected element is shown.
                </p>
                <p>Left-Click</p>
                <ul>
                    <li>
                        When no element is set, a place can be created by a
                        click on the canvas.
                    </li>
                    <li>
                        When no element is set, a click on an existing place or
                        transition sets the node as a starting point for the
                        next action.
                    </li>
                    <li>
                        When an element is set, a click on an empty place in the
                        canvas creates a new place or transition
                    </li>
                    <li>
                        When an element is set, a click on an existing node
                        connects both nodes if possible.
                    </li>
                </ul>
                <p>Right-Click</p>
                <ul>
                    <li>The selected in the Blitz tool can be reset.</li>
                    <li>
                        An existing arc or node can be deleted by clicking on
                        it.
                    </li>
                </ul>
                <p>Scrolling</p>
                <ul>
                    <li>
                        By scrolling over an arc the amount of marks can be
                        increased or decreased.
                    </li>
                    <li>
                        By scrolling over a transition, its label can be changed
                        to the next or the previous action. When scrolling past
                        the last element, the label will be empty.
                    </li>
                </ul>
                <p>Mousewheel-Click</p>
                <ul>
                    <li>
                        When no element is set, a transition can be created by a
                        click on the canvas.
                    </li>
                </ul>
            </div>

            <h2 class="grid-span-2">Add petri net elements</h2>

            <mat-icon class="help-icon">circle</mat-icon>
            <p>Place mode: Left-click in the canvas area to set a new place.</p>

            <mat-icon class="help-icon">square</mat-icon>
            <p>
                Transition mode: Left-click in the canvas area to set a new
                transition.
            </p>

            <mat-icon class="help-icon">north_east</mat-icon>
            <div>
                <p>
                    Arc mode: To add a new arc from a start node (place or
                    transition) to a complementary end node (transition or
                    place)
                </p>
                <ul>
                    <li>
                        left-click on the start node and keep the mouse button
                        pressed down, then
                    </li>
                    <li>drag the arraow into the end node and</li>
                    <li>release the mouse to finalize the arc.</li>
                </ul>
                <p>
                    To abort an ongoing arc drawing, just release the mouse
                    button anywhere in the empty area of the canvas.
                </p>
            </div>

            <mat-icon class="help-icon">linear_scale</mat-icon>
            <div>
                <p>Anchor mode: To add a new anchor point to an arc</p>
                <ul>
                    <li>
                        left-click on the arc and hold the mouse button pressed
                        down &rAarr; the application temporarily switches into
                        'Move' mode,
                    </li>
                    <li>drag the anchor point to its desired position and</li>
                    <li>release the mouse button to set the anchor point.</li>
                </ul>
            </div>

            <h2 class="grid-span-2">Tokens and weights</h2>

            <mat-icon class="help-icon">add</mat-icon>
            <div>
                <p>
                    Increase mode: In increase mode, you can increase the token
                    number of a place or the weight of an arc.
                </p>
                <p>To increase the token number of a place</p>
                <ul>
                    <li>left-click on the place or</li>
                    <li>
                        hover over the place and scroll-up with the mouse wheel.
                    </li>
                </ul>
                <p>To increase the weight of an arc</p>
                <ul>
                    <li>left-click on the arc or</li>
                    <li>
                        hover over the arc and scroll-up with the mouse wheel.
                    </li>
                </ul>
            </div>

            <mat-icon class="help-icon">remove</mat-icon>
            <div>
                <p>
                    Decrease mode: In decrease mode, you can decrease the token
                    number of a place or the weight of an arc.
                </p>
                <p>To decrease the token number of a place</p>
                <ul>
                    <li>left-click on the place or</li>
                    <li>
                        hover over the place and scroll-down with the mouse
                        wheel.
                    </li>
                </ul>
                <p>To decrease the weight of an arc</p>
                <ul>
                    <li>left-click on the arc or</li>
                    <li>
                        hover over the arc and scroll-down with the mouse wheel.
                    </li>
                </ul>
                <p>
                    Note that the minimum value for both tokens of a place and
                    weights of an arc is 1. Further reduction below this value
                    is not possible.
                </p>
            </div>

            <h2 class="grid-span-2">Delete</h2>

            <mat-icon class="help-icon">delete</mat-icon>
            <p>
                Delete mode: Left-click any individual element (place,
                transition, anchor or arc) to delete it.
            </p>

            <mat-icon class="help-icon">clear</mat-icon>
            <p>
                Clear mode: Click the button to delete the whole petri net. A
                popup will ask you to confirm your delete action in order to
                prevent unintentional data loss.
            </p>

            <h2 class="grid-span-2">Move</h2>

            <mat-icon class="help-icon">open_with</mat-icon>
            <div>
                <p>
                    Move mode: In move mode, you can move individual elements or
                    the complete petri net at once.
                </p>
                <p>
                    All elements, that can be moved individually (places,
                    transitions or anchor points), are highlighted with a red
                    dropshadow. To move an individual element
                </p>
                <ul>
                    <li>
                        left-click on the element and keep the mouse button
                        pressed down,
                    </li>
                    <li>drag the element to its new position and</li>
                    <li>
                        release the mouse button to place the element at the new
                        location.
                    </li>
                </ul>
                <p>To move the complete petri net at once</p>
                <ul>
                    <li>
                        left-click anywhere on an empty spot on the canvas and
                        keep the mouse button pressed down (the whole petri net
                        will light up),
                    </li>
                    <li>drag the mouse to move the petri net and</li>
                    <li>
                        release the mouse button to place the petri net at its
                        new position.
                    </li>
                </ul>
            </div>

            <h2 class="grid-span-2">Actions</h2>
            <mat-icon class="help-icon">ads_click</mat-icon>
            <div>
                <p>Action assignment mode:</p>
                <ul>
                    <li>
                        Allows assigning actions to transitions as labels.
                        Clicking a transition using this tool will open a dialog
                        that lets you specify which action should be used as
                        label for this transition. By selecting "-" you can also
                        remove a set label assignment and turn the selected
                        transition into a silent transition.
                    </li>
                    <li>
                        You can also hover a transition and use the scroll wheel
                        to successively switch through all defined actions.
                    </li>
                </ul>
            </div>

            <mat-icon class="help-icon">edit_note</mat-icon>
            <p>
                Opens the action management dialog. In this dialog actions can
                be created and removed. These actions can then be used for
                assignment as transition labels using the the action assignment
                tool (described above). Note that only actions which are not
                currently used as labels can be deleted.
            </p>
        </div>
        <div class="grid">
            <h2 class="grid-span-2">Layout</h2>
            <button mat-stroked-button class="help-text-button">
                Spring Embedder
            </button>
            <div>
                <p>
                    Apply automatic layout to the petri net with a Spring
                    Embedder algorithm. Orphan nodes will stay in their original
                    position.
                </p>
                <p>
                    The implementation of the Spring Embedder algorithm is based
                    on Eades algorithm for force directed graph drawing from
                    1984
                    <span class="reference"
                        >[P. Eades, A heuristic for graph drawing, Congressus
                        Numerantium, Vol. 42, pp. 149-160, 1984]</span
                    >.
                </p>
                <p>
                    For the purpose of drawing the petri net, nodes repel each
                    other while arcs are implemented to act like springs,
                    applying directional forces based on being stretched or
                    compressed. The forces generated are calculated in an
                    iterative procedure. Each iteration is comprised of the
                    following steps:
                </p>
                <ul>
                    <li>
                        A force vector is calculated for each node. This force
                        vector is composed of the sum of the repulsive forces
                        from all other nodes in the petri net and the spring
                        forces from connected nodes.
                    </li>
                    <li>
                        The force vectors are applied to the nodes and their
                        positions are updated accordingly.
                    </li>
                </ul>
                <p>The algorithm terminates as soon as either</p>
                <ul>
                    <li>
                        the lengths of all force vectors fall below a certain
                        threshold (meaning the petri net has settled and any
                        further change would be minimal) or
                    </li>
                    <li>20,000 iterations are reached.</li>
                </ul>
            </div>

            <button mat-stroked-button class="help-text-button">
                Sugiyama
            </button>
            <div>
                <p>
                    Apply automatic layered graph layout to the petri net with a
                    Sugiyama algorithm. Orphan nodes will be placed in the first
                    column of the new layout.
                </p>
                <p>
                    The implementation of the Sugiyama algorithm in this
                    application uses the following steps and algorithms:
                </p>
                <ul>
                    <li>
                        Circles in the graph are removed through a Depth-First
                        Search (DFS) algorithm.
                    </li>
                    <li>
                        Each individual node is then assigned to a layer by an
                        implementation of the Longest Path Algorithm proposed by
                        Tamassia et al.
                        <span class="reference"
                            >[R. Tamassia, Handbook of Graph Drawing and
                            Visualization, 2010]</span
                        >.
                    </li>
                    <li>
                        The nodes are then ordered to minimize arc crossings
                        using the median ordering method with transpose as
                        proposed by Ganser et al.
                        <span class="reference"
                            >[E. Gansner, E. Koutsofios, S. North, and K.-P. Vo,
                            A technique for drawing directed graphs, 1993]</span
                        >.
                    </li>
                    <li>
                        Finally, new coordinates are assigned to each node
                        through a basic algorithm that places the node layers in
                        even distances to each other.
                    </li>
                </ul>
            </div>
        </div>
    </ng-container>

    <!-- Infotext for Play Mode ******************************************* -->
    <ng-container *ngIf="uiService.tab === TabState.Play">
        <h2>Token game</h2>

        <p>In Play mode, you can:</p>
        <ul>
            <li>
                Fire transitions to see how the tokens progress through the
                petri net.
            </li>
            <li>Reset the token game to the initial marking.</li>
            <li>Go back on step if you clicked the wrong transition.</li>
        </ul>

        <div class="grid">
            <h2 class="grid-span-2">Firing transitions</h2>
            <p class="grid-span-2">
                To fire a transition, just click one of the highlighted, green,
                transitions.
            </p>

            <h2 class="grid-span-2">Undo & Reset</h2>
            <mat-icon class="help-icon">restart_alt</mat-icon>
            <p>
                Reset token game: Reset petri net marking to its initial state
                at the beginning of the token game.
            </p>

            <mat-icon class="help-icon">fast_rewind</mat-icon>
            <p>
                Step back: Set the petri net marking one step back to the state
                before the last transition firing. Can be applied multiple times
                until you reach the start state of the token game.
            </p>
        </div>
    </ng-container>

    <!-- Infotext for Save Mode ******************************************* -->
    <ng-container *ngIf="uiService.tab === TabState.Save">
        <div class="grid">
            <h2 class="grid-span-2">Save petri net as data file</h2>

            <button mat-stroked-button class="help-text-button">JSON</button>
            <p>Save petri net data in JSON format.</p>

            <button mat-stroked-button class="help-text-button">PNML</button>
            <p>
                Save petri net data in PNML (Petri Net Meta Language) format (<a
                    href="https://www.pnml.org/"
                    target="_blank"
                    >PNML.org</a
                >). The format is based on XML.
            </p>

            <h2 class="grid-span-2">Save petri net as image</h2>

            <button mat-stroked-button class="help-text-button">PNG</button>
            <p>Save in PNG (Portable Network Graphics) raster format.</p>

            <button mat-stroked-button class="help-text-button">SVG</button>
            <p>Save in SVG (Scalable Vector Graphics) vector format.</p>
        </div>
    </ng-container>

    <!-- Infotext for Code Tab ******************************************** -->
    <ng-container *ngIf="uiService.tab === TabState.Code">
        <div class="grid">
            <h2 class="grid-span-2">Code editor actions</h2>

            <mat-icon class="help-icon">restart_alt</mat-icon>
            <p>
                Reload the contents of the code editor. This is done via
                serializing the internal state of the petri net in the selected
                format and replacing the contents of the editor with the created
                code.
            </p>

            <mat-icon class="help-icon">task</mat-icon>
            <p>
                Apply the contents of the code editor. If parsing and schema
                validation indicate that the code is syntactically and
                semantically correct then the current petri net will be replaced
                with the one parsed from the code editor. As of yet schema
                validation is only available for the JSON format.
            </p>

            <h2 class="grid-span-2">Supported formats</h2>

            <button mat-stroked-button class="help-text-button">JSON</button>
            <p>
                Switches the displayed source code to the JSON format. This
                action essentially reloads the code editor and will dismiss any
                changes you have made but not yet applied.
            </p>

            <button mat-stroked-button class="help-text-button">PNML</button>
            <p>
                Switches the displayed source code to the PNML format. Similarly
                to the JSON button, this essentially reloads the code editor and
                will dismiss any changes you have made but not yet applied.
            </p>
        </div>
    </ng-container>

    <!-- Infotext for Analyze Mode **************************************** -->
    <ng-container *ngIf="uiService.tab === TabState.Analyze">
        <p>
            In Analyze mode, you can calculate place invariants of the petri net
            and inspect the results in different ways.
        </p>
        <h2>Calculation</h2>
        <div class="grid">
            <button mat-stroked-button class="help-text-button">
                Place Invariants (Farkas)
            </button>
            <div>
                <p>
                    Pressing this button will calculate place invariants with
                    the Farkas algorithm. A popup window will appear with the
                    results of the calculation. It presents a table where each
                    table row represents one place invariant.
                </p>
                <p>
                    The results of the Farkas algorithm contain all minimal
                    place invariants, but they may also contain additional place
                    invariants that are non-minimal. If you want to exclusively
                    calculate minimal place invariants, use the next calculation
                    option described below.
                </p>
                <p>
                    The Farkas algorithm for the calculation of place invariants
                    is described in various publications, for example Martinez &
                    Silva
                    <span class="reference"
                        >[Mart√≠nez, J., Silva, M. (1982). A simple and Fast
                        Algorithm to Obtain all Invariants of a Generalised
                        Petri Net. In: Girault, C., Reisig, W. (eds) Application
                        and Theory of Petri Nets. Informatik-Fachberichte, vol
                        52. Springer, Berlin, Heidelberg.
                        https://doi.org/10.1007/978-3-642-68353-4_47]</span
                    >.
                </p>
            </div>
            <button mat-stroked-button class="help-text-button">
                Minimal Place Invariants
            </button>
            <div>
                <p>Pressing this button will</p>
                <ul>
                    <li>
                        calculate the place invariants with the Farkas algorithm
                        as above,
                    </li>
                    <li>and then remove all non-minimal invariants.</li>
                </ul>
                <p>
                    The results of the calculation will now only contain the
                    minimal place invariants.
                </p>
                <p>
                    The removal of non-minimal place invariants is implemented
                    following the algorithm described in Martinez & Silva
                    <span class="reference">[see above]</span>.
                </p>
            </div>
        </div>
        <p>
            After either of the calculations, all places that are part of the
            support of one or several of the calculated place invariants are
            highlighted in blue. These places are then also part of the support
            of the LC place invariant that results from linear combination (LC)
            of all result place invariants. The non-zero values of this LC place
            invariant are shown as factors with the place ids in the petri net
            graph.
        </p>

        <h2>Place invariants for a specific place</h2>
        <p>
            After the calculation of place invariants, you may see the place
            invariants that have a specific place in their support by clicking
            on that place in the petri net graph. The place invariants for a
            specific place may contain both place invariants that have been
            selected or deselected for the linear combination (see below). Those
            that are included in the current linear combination are highlighted
            in blue, those that have been deselected are highlighted in white.
        </p>

        <h2>Linear Combination</h2>
        <p>
            With the 'Linear Combination' functionality you have the option, to
            further inspect the results of the calculation by selecting specific
            place invariants (or just one) for linear combination. The resulting
            LC place invariant is shown above the table as an equation together
            with its value. It is also shown in the petri net graph as blue
            highlighted places together with the values of the LC place
            invariant as factors with the place ids.
        </p>
        <div class="grid">
            <button mat-stroked-button class="help-text-button">
                Linear Combination
            </button>
            <div>
                <p>
                    Pressing this button will open a table with all place
                    invariants of the calculation for linear combination
                    selection. Directly after the calculation, the linear
                    combination consists of all place invariants. You may select
                    or deselect place invariants in any combination by clicking
                    the respective table rows. Selected place invariants are
                    highlighted in blue and deselected place invariants are
                    highlighted in white.
                </p>
            </div>
        </div>
    </ng-container>
</div>
